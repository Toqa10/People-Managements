# -*- coding: utf-8 -*-
"""HR.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1BRPDra8Zdc_vshxER2aey6dnJ-HG5b7a
"""

import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import io

# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
st.set_page_config(page_title="HR Insights", layout="wide")
sns.set_style("whitegrid")

# --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
@st.cache_data
def load_data():
    def read_file(name):
        try:
            return pd.read_csv(name)
        except FileNotFoundError:
            return pd.DataFrame()

    return (
        read_file("current_employee_snapshot.csv"),
        read_file("department_employee.csv"),
        read_file("employee.csv"),
        read_file("department.csv"),
        read_file("salary.csv"),
        read_file("title.csv"),
        read_file("department_manager.csv"),
    )

current_emp_snapshot, department_employee, employee, department, salary, title, department_manager = load_data()

# --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø³Ø¨Ù‚Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
if not salary.empty and all(col in salary.columns for col in ['from_date', 'employee_id', 'amount']):
    salary['year'] = pd.to_datetime(salary['from_date']).dt.year
    salary_sorted = salary.sort_values(['employee_id', 'from_date'])
    salary_sorted['prev_salary'] = salary_sorted.groupby('employee_id')['amount'].shift(1)
    salary_sorted['salary_growth'] = salary_sorted['amount'] - salary_sorted['prev_salary']
    salary_sorted['growth_year'] = pd.to_datetime(salary_sorted['from_date']).dt.year
else:
    salary_sorted = pd.DataFrame()
    st.warning("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø£Ùˆ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©")

# Ø£ÙØ¶Ù„ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
if not current_emp_snapshot.empty and all(col in current_emp_snapshot.columns for col in ['dept_name', 'salary_amount']):
    top_10 = current_emp_snapshot.groupby("dept_name", as_index=False).apply(
        lambda x: x.nlargest(10, "salary_amount")
    ).reset_index(drop=True)
else:
    top_10 = pd.DataFrame()
    if not current_emp_snapshot.empty:
        st.warning("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (dept_name Ø£Ùˆ salary_amount)")

# --- Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª ---
def fig_to_image(fig):
    buf = io.BytesIO()
    fig.savefig(buf, format="png", bbox_inches='tight', dpi=300)
    buf.seek(0)
    return buf

# --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
st.title("ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©")
st.markdown("Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¤Ù‰ Ù…Ø±Ø¦ÙŠØ© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†")

# Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ØªÙØªÙŠØ´
with st.expander("ğŸ” Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©"):
    st.write("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†:", current_emp_snapshot.head(3) if not current_emp_snapshot.empty else "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª")
    st.write("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨:", salary_sorted.head(3) if not salary_sorted.empty else "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª")

question = st.text_input("â“ Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ù…Ø«Ø§Ù„: Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§ØªØ¨ØŒ Ù†Ù…Ùˆ Ø§Ù„Ø±ÙˆØ§ØªØ¨...)")

# Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©
allowed_questions = {
    "top salaries": "Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…",
    "highest paid": "Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…",
    "salary growth": "Ù†Ù…Ùˆ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³Ù†ÙˆÙŠ",
    "average salary per gender": "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø§ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³",
    "gender salary": "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø§ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³",
    "tenure vs salary": "Ø§Ù„Ø®Ø¨Ø±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø±Ø§ØªØ¨",
    "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§ØªØ¨": "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§ØªØ¨"
}

# --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ---
if question:
    q = question.lower()
    matched = [key for key in allowed_questions if key in q]

    if matched:
        chart_title = allowed_questions[matched[0]]
        st.success(f"âœ… Ø¹Ø±Ø¶ Ù…Ø®Ø·Ø· Ù„Ù€: {chart_title}")
        
        try:
            fig, ax = plt.subplots(figsize=(10, 6))
            plt.tight_layout()
            
            if "salary growth" in matched[0]:
                if not salary_sorted.empty and 'growth_year' in salary_sorted.columns:
                    avg_growth = salary_sorted.groupby("growth_year")["salary_growth"].mean().reset_index()
                    sns.lineplot(data=avg_growth, x="growth_year", y="salary_growth", marker='o', ax=ax)
                    ax.set_title("ğŸ“ˆ Ù…ØªÙˆØ³Ø· Ù†Ù…Ùˆ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³Ù†ÙˆÙŠ")
                    ax.set_xlabel("Ø§Ù„Ø³Ù†Ø©")
                    ax.set_ylabel("Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ")
                else:
                    st.error("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù…Ùˆ Ø§Ù„Ø±ÙˆØ§ØªØ¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø£Ùˆ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©")

            elif "top salaries" in matched[0] or "highest paid" in matched[0]:
                if not top_10.empty:
                    top10_plot = top_10.groupby("dept_name").head(1).sort_values("salary_amount", ascending=False)
                    sns.barplot(data=top10_plot, x="dept_name", y="salary_amount", ax=ax, palette="viridis")
                    ax.set_title("ğŸ† Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø±Ø§ØªØ¨Ø§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…")
                    ax.set_xlabel("Ø§Ù„Ù‚Ø³Ù…")
                    ax.set_ylabel("Ø§Ù„Ø±Ø§ØªØ¨")
                    plt.xticks(rotation=45)
                else:
                    st.error("Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§ØªØ¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©")

            elif "gender salary" in matched[0]:
                if not current_emp_snapshot.empty and all(col in current_emp_snapshot.columns for col in ['gender', 'salary_amount']):
                    sns.barplot(data=current_emp_snapshot, x="gender", y="salary_amount", estimator='mean', ax=ax, palette="coolwarm")
                    ax.set_title("âš–ï¸ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø§ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³")
                    ax.set_xlabel("Ø§Ù„Ø¬Ù†Ø³")
                    ax.set_ylabel("Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø§ØªØ¨")
                else:
                    st.error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©")

            elif "tenure vs salary" in matched[0]:
                if not current_emp_snapshot.empty and all(col in current_emp_snapshot.columns for col in ['tenure', 'salary_amount']):
                    current_emp_snapshot_clean = current_emp_snapshot.dropna(subset=["tenure", "salary_amount"])
                    sns.scatterplot(data=current_emp_snapshot_clean, x="tenure", y="salary_amount", ax=ax, alpha=0.6)
                    ax.set_title("ğŸ“‰ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¨ÙŠÙ† Ø§Ù„Ø®Ø¨Ø±Ø© ÙˆØ§Ù„Ø±Ø§ØªØ¨")
                    ax.set_xlabel("Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¨Ø±Ø©")
                    ax.set_ylabel("Ø§Ù„Ø±Ø§ØªØ¨")
                else:
                    st.error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø¨Ø±Ø© ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©")

            elif "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§ØªØ¨" in matched[0]:
                if not current_emp_snapshot.empty and 'salary_amount' in current_emp_snapshot.columns:
                    sns.histplot(current_emp_snapshot['salary_amount'], kde=True, ax=ax, bins=30)
                    ax.set_title("ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§ØªØ¨")
                    ax.set_xlabel("Ø§Ù„Ø±Ø§ØªØ¨")
                    ax.set_ylabel("Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†")
                else:
                    st.error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©")

            # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø·Ø· Ø¥Ø°Ø§ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨Ù†Ø¬Ø§Ø­
            if ax.has_data():
                st.pyplot(fig)
                st.download_button(
                    label="â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·",
                    data=fig_to_image(fig),
                    file_name=f"{matched[0]}.png",
                    mime="image/png"
                )
            else:
                st.warning("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø®Ø·Ø·")

        except Exception as e:
            st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø®Ø·Ø·: {str(e)}")

    else:
        st.warning("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø£Ùˆ ØºÙŠØ± ÙˆØ§Ø¶Ø­")
        st.write("Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©:")
        for q, desc in allowed_questions.items():
            st.write(f"- {q}: {desc}")
