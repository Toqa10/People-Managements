# -*- coding: utf-8 -*-
"""HR.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1BRPDra8Zdc_vshxER2aey6dnJ-HG5b7a
"""
import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import io

# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
st.set_page_config(page_title="HR Insights", layout="wide")
sns.set_style("whitegrid")

# --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
@st.cache_data
def load_data():
    def read_file(name):
        try:
            df = pd.read_csv(name)
            # ØªØ­ÙˆÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¥Ù„Ù‰ Ø£Ø­Ø±Ù ØµØºÙŠØ±Ø© ÙˆØªÙ†Ø¸ÙŠÙÙ‡Ø§
            df.columns = df.columns.str.lower().str.strip().str.replace(' ', '_')
            return df
        except Exception as e:
            st.warning(f"Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù {name}: {str(e)}")
            return pd.DataFrame()

    return (
        read_file("current_employee_snapshot.csv"),
        read_file("department_employee.csv"),
        read_file("employee.csv"),
        read_file("department.csv"),
        read_file("salary.csv"),
        read_file("title.csv"),
        read_file("department_manager.csv"),
    )

current_emp, dept_emp, employee, department, salary, title, dept_manager = load_data()

# --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø³Ø¨Ù‚Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
def preprocess_data():
    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨
    salary_processed = pd.DataFrame()
    if not salary.empty:
        required_cols = ['from_date', 'employee_id', 'amount']
        if all(col in salary.columns for col in required_cols):
            try:
                salary_processed = salary.copy()
                salary_processed['year'] = pd.to_datetime(salary_processed['from_date']).dt.year
                salary_processed = salary_processed.sort_values(['employee_id', 'from_date'])
                salary_processed['prev_salary'] = salary_processed.groupby('employee_id')['amount'].shift(1)
                salary_processed['salary_growth'] = salary_processed['amount'] - salary_processed['prev_salary']
                salary_processed['growth_year'] = pd.to_datetime(salary_processed['from_date']).dt.year
            except Exception as e:
                st.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨: {str(e)}")
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†
    top_salaries = pd.DataFrame()
    if not current_emp.empty:
        required_cols = ['dept_name', 'salary_amount']
        if all(col in current_emp.columns for col in required_cols):
            try:
                top_salaries = (
                    current_emp.groupby("dept_name", group_keys=False)
                    .apply(lambda x: x.nlargest(10, "salary_amount"))
            except Exception as e:
                st.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§ØªØ¨: {str(e)}")
    
    return salary_processed, top_salaries

salary_processed, top_salaries = preprocess_data()

# --- Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª ---
def fig_to_image(fig):
    buf = io.BytesIO()
    fig.savefig(buf, format="png", bbox_inches='tight', dpi=300)
    buf.seek(0)
    return buf

# --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
st.title("ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©")

# Ù‚Ø³Ù… ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
with st.expander("ğŸ” ØªØ´Ø®ÙŠØµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"):
    st.write("### Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨ÙŠØ§Ù†Ø§Øª:")
    st.write(f"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†: {list(current_emp.columns) if not current_emp.empty else 'ÙØ§Ø±ØºØ©'}")
    st.write(f"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨: {list(salary.columns) if not salary.empty else 'ÙØ§Ø±ØºØ©'}")
    
    if not current_emp.empty:
        st.write("### Ø¹ÙŠÙ†Ø© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:")
        st.write(current_emp.head(3))

# --- Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø© ---
allowed_questions = {
    "top salaries": {
        "description": "Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…",
        "required_cols": ['dept_name', 'salary_amount']
    },
    "salary growth": {
        "description": "Ù†Ù…Ùˆ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³Ù†ÙˆÙŠ", 
        "required_cols": ['growth_year', 'salary_growth']
    },
    "gender salary": {
        "description": "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø§ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³",
        "required_cols": ['gender', 'salary_amount']
    },
    "tenure salary": {
        "description": "Ø§Ù„Ø®Ø¨Ø±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø±Ø§ØªØ¨",
        "required_cols": ['tenure', 'salary_amount']
    }
}

# --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ---
question = st.text_input("â“ Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†")

if question:
    q = question.lower()
    matched = [key for key in allowed_questions if key in q]
    
    if matched:
        question_info = allowed_questions[matched[0]]
        st.success(f"âœ… Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ±: {question_info['description']}")
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        missing_cols = [col for col in question_info['required_cols'] 
                       if col not in current_emp.columns and col not in salary_processed.columns]
        
        if missing_cols:
            st.error(f"Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©: {missing_cols}")
        else:
            try:
                fig, ax = plt.subplots(figsize=(10, 6))
                
                if "top salaries" in matched[0]:
                    if not top_salaries.empty:
                        plot_data = top_salaries.groupby("dept_name").head(1).sort_values("salary_amount", ascending=False)
                        sns.barplot(data=plot_data, x="dept_name", y="salary_amount", ax=ax)
                        ax.set_title("Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…")
                        plt.xticks(rotation=45)
                
                elif "salary growth" in matched[0]:
                    if not salary_processed.empty:
                        plot_data = salary_processed.groupby("growth_year")["salary_growth"].mean().reset_index()
                        sns.lineplot(data=plot_data, x="growth_year", y="salary_growth", ax=ax, marker='o')
                        ax.set_title("Ù†Ù…Ùˆ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³Ù†ÙˆÙŠ")
                
                elif "gender salary" in matched[0]:
                    if not current_emp.empty:
                        sns.barplot(data=current_emp, x="gender", y="salary_amount", ax=ax, estimator='mean')
                        ax.set_title("Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø§ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³")
                
                elif "tenure salary" in matched[0]:
                    if not current_emp.empty:
                        current_emp_clean = current_emp.dropna(subset=["tenure", "salary_amount"])
                        sns.scatterplot(data=current_emp_clean, x="tenure", y="salary_amount", ax=ax)
                        ax.set_title("Ø§Ù„Ø®Ø¨Ø±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø±Ø§ØªØ¨")
                
                st.pyplot(fig)
                st.download_button("â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·", data=fig_to_image(fig), 
                                 file_name=f"{matched[0]}.png", mime="image/png")
                
            except Exception as e:
                st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø®Ø·Ø·: {str(e)}")
    else:
        st.warning("Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©:")
        for q, info in allowed_questions.items():
            st.write(f"- {q}: {info['description']}")
